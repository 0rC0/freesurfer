#!/bin/tcsh -ef
#
# make_average_subject
#
# Creates average surfaces, curvatures, and volumes from a set of subjects.
#
# --help option will show usage
#

set VERSION = '$Id: make_average_subject,v 1.2 2005/09/09 14:37:17 nicks Exp $'

set PrintHelp = 0;

if ( $?SUBJECTS) then
    set SUBJECTS=($SUBJECTS)
endif
if ( $?SUBJECTS_DIR) then
    set SUBJECTS_DIR=($SUBJECTS_DIR)
endif

set average_subject=average
set ddir = ${SUBJECTS_DIR}/${average_subject}
set transform_fname=""
set XFORM_FLAG=""

# note: SUBJECTS can be set by --subjects
# SUBJECTS_DIR can be set by --sdir
# average_subject can be set by --out
# transform_fname can be set by --xform (default is no file specified)
# XFORM_FLAG appends -X to transform_fname if --xform is specified

if($#argv == 0) then
  # zero args is allowed only if SUBJECTS env var is declared
  if ( ! $?SUBJECTS) then
    goto usage_exit;
  endif
endif

set n = `echo $argv | grep -e --help | wc -l` 
if($n != 0) then
  set PrintHelp = 1;
  goto usage_exit;
endif

set n = `echo $argv | grep -e --version | wc -l` 
if($n != 0) then
  echo $VERSION
  exit 0;
endif

make_average_surface $argv
if($status) exit 1;

make_average_volume $argv
if($status) exit 1;

exit 0
#----------------------------------------------------------#

############--------------##################
usage_exit:
  echo ""
  echo "USAGE: make_average_subject"
  echo ""
  echo "Required Arguments"
  echo "   --subjects <subj1> <subj2> ... <subjN>" 
  echo "             : or declare subjects in SUBJECTS env var"
  echo ""
  echo "Optional Arguments"
  echo "   --out <average subject name>    : default name is 'average'"
  echo "   --sdir <SUBJECTS_DIR to use instead of the one in the env>"
  echo "   --sd      : same as --sdir"
  echo "   --xform <transform_fname>       : filename of transform file"
  echo ""
  echo "   --help    : short descriptive help"
  echo "   --version : script version info"
  echo "   --echo    : enable command echo, for debug"
  echo ""

  if(! $PrintHelp) exit 1;

  echo Version: $VERSION

  cat $0 | awk 'BEGIN{prt=0}{if(prt) print $0; if($1 == "BEGINHELP") prt = 1 }'

exit 1;


#---- Everything below here is printed out as part of help -----#
BEGINHELP

Creates average subject by averaging surfaces, curvatures, and volumes
from a set of subjects. The surface is a 7th order icosahedron
tesselation.  For surfaces, the XYZ coordinate of a vertex is computed
as the average talairach coordinate of that vertex in each subject. The 
talairach coordinate is based on talairach.xfm (unless changed with
--xform), so the individual talairachs must be accurate for the final 
coordinate to be meaningful. Note that even though talairach coordinates
are used for surfaces, all surface-based averaging is done using the
surface atlas (NOT talairach averaging!).

Calls make_average_surface and make_average_volume. See these programs
for specific help.

The subject list can be specified in one of two ways: 
  (1) on the command-line with --subjects
  (2) through the SUBJECTS environment variable

EXAMPLES

Example 1:

  make_average_subject --out avgsubject --subjects subj1 subj2 subj3 subj4

will create $SUBJECTS_DIR/avgsubject with average surfaces for orig,
white, pial, inflated for each hemi. It will also create average volumes
for orig, brain, and T1.  Notice that the '--out avgsubject' is merely
overriding the default output name 'average'.

Example 2:

  setenv SUBJECTS = (subj1 subj2 subj3 subj4)
  make_average_subject --out avgsubject 

will do the same as Example 1.

Example 3: check that the average subject volume aligns with the 
talairach subject:

  tkregister2 --fstal --s avgsubject --mgz

Example 4: check that the average subject surfaces align with the 
volume:

  tkmedit avgsubject orig.mgz lh.white

You should see that the surfaces more-or-less align with the folds.
Remember this is talairach, so the volume will be blurry.

SEE ALSO

make_average_volume, make_average_surface, recon-all, make_final_surfaces, 
morph_subject

GETTING HELP

Run recon-all --help for extensive text on the reconstruction process. 
Or, send email to freesurfer@nmr.mgh.harvard.edu 
See also https://surfer.nmr.mgh.harvard.edu
