#ifndef _itk_CurrentsSplineMeshCorrespondencesCalculator_h
#define _itk_CurrentsSplineMeshCorrespondencesCalculator_h
#include "itkKdTree.h"
#include "itkKdTreeGenerator.h"
#include "itkListSample.h"
#include "itkMeshCorrespondencesCalculatorBase.h"

namespace itk
{
  
  template < class TFixedMesh, class TMovingMesh >
    class CurrentsSplineMeshCorrespondencesCalculator :
  public MeshCorrespondencesCalculatorBase < TFixedMesh, TMovingMesh >
  {
  public:
    typedef CurrentsSplineMeshCorrespondencesCalculator       Self;
    typedef MeshCorrespondencesCalculatorBase
      < TFixedMesh, TMovingMesh >                           Superclass;
    typedef SmartPointer<Self>                              Pointer;
    typedef SmartPointer<const Self>                        ConstPointer;

    itkNewMacro  (Self);
    itkTypeMacro (CurrentsSplineMeshCorrespondencesCalculator, MeshCorrespondencesCalculatorBase);
    

    typedef typename Superclass::FixedMeshType    FixedMeshType;
    typedef typename Superclass::FixedMeshTraits  FixedMeshTraits;
    typedef typename Superclass::FixedPointType   FixedPointType;
    typedef typename Superclass::FixedPixelType   FixedPixelType;
    typedef typename Superclass::FixedVectorType  FixedVectorType;


    typedef typename Superclass::MovingMeshType    MovingMeshType;
    typedef typename Superclass::MovingMeshTraits  MovingMeshTraits;
    typedef typename Superclass::MovingPointType   MovingPointType;
    typedef typename Superclass::MovingPixelType   MovingPixelType;
    typedef typename Superclass::MovingVectorType  MovingVectorType;


    /** Some convenient typedefs. */
    typedef typename Superclass::FixedMeshPointer      FixedMeshPointer;
    typedef typename Superclass::FixedCellTraits       FixedCellTraits;
    typedef typename Superclass::FixedCellIdentifier   FixedCellIdentifier;
    typedef typename Superclass::FixedCellType         FixedCellType;
    typedef typename Superclass::FixedCellAutoPointer  FixedCellAutoPointer;
    typedef typename Superclass::FixedPointIdentifier  FixedPointIdentifier;
    typedef typename Superclass::FixedPointIdIterator  FixedPointIdIterator;


    typedef typename Superclass::MovingMeshPointer       MovingMeshPointer;
    typedef typename Superclass::MovingCellTraits        MovingCellTraits;
    typedef typename Superclass::MovingCellIdentifier    MovingCellIdentifier;
    typedef typename Superclass::MovingCellType          MovingCellType;
    typedef typename Superclass::MovingCellAutoPointer   MovingCellAutoPointer;
    typedef typename Superclass::MovingPointIdentifier   MovingPointIdentifier;
    typedef typename Superclass::MovingPointIdIterator   MovingPointIdIterator;

    // K-d tree typedefs
    typedef Vector< double, 3 >                             MeasurementVectorType;
    typedef Statistics::ListSample< MeasurementVectorType > SampleType;
    typedef Statistics::KdTreeGenerator< SampleType >       TreeGeneratorType;
    typedef typename TreeGeneratorType::KdTreeType          TreeType;
    typedef typename TreeType::NearestNeighbors             NeighborsType;
    typedef typename TreeType::KdTreeNodeType               NodeType;
    typedef Statistics::EuclideanDistanceMetric< MeasurementVectorType > DistanceMetricType;



    virtual void Evaluate (void);
    virtual void RecalculateSigma(void);    
//    void SetSigma(double s ){ this->sigma =  s ; }
    //void SetSigmaCurrents(double s ){ this->sigmaCurrents =  s ; }
    void SetUpsamplingPointsNumber(unsigned int n){this->upsamplingPointsNumber= n;}


   // double GetSigmaCurrents( ){return this->sigmaCurrents; }
  protected:
    CurrentsSplineMeshCorrespondencesCalculator();
    ~CurrentsSplineMeshCorrespondencesCalculator() {}
    
  private:
    CurrentsSplineMeshCorrespondencesCalculator (const Self&);
    void operator=(const Self&);   
  //  double sigma;
    //double sigmaCurrents;
    double lastMetric;
    unsigned int upsamplingPointsNumber;
 
  };  
}

#ifndef ITK_MANUAL_INSTANTIATION
#include "itkCurrentsSplineMeshCorrespondencesCalculator.txx"
#endif

#endif

