# The first thing to do (but only needs to be done once), is to rasterize the 
# aggregated prior for right hippocampus from the atlas mesh you are going to
# use. This was done as follows:
#
#    kvlMapLabelsOfAtlasMesh CurrentMeshCollection30.gz compressionLookupTable.txt 1
#    kvlViewMeshCollectionWithGUI CurrentMeshCollection30.gz_mapped.txt.gz
#         and then select the reference mesh, the second label (hippocampus), and dump
#    kvlConvert imageDump.vtk imageDump.mgz hippocampusTemplateMasked.mgz
#
# As a result, imageDump.mgz is the prior for right hippocampus, floating in the 
# correct world coordinates. This is the image you are going to work with. 
#


# Define a function that will show what we're doing, and
# exits if something goes wrong
function doIt {
  echo $1
  eval $1
  if [ $? != 0 ]; then
    echo "failed to do $1"
  exit
fi

}


# First extract the right hippocampus from the aseg segmentation (label 53)
doIt "kvlBinaryThresholdImage aseg.mgz 53"

# Coregister the hippocampal prior image affinely with the binary aseg hippocampus
doIt "kvlRegister imageDump.mgz aseg_thresholded.mgz 12 1"

# Have a look at the result
doIt "kvlResample aseg_thresholded.mgz imageDump_coregistered.mgz";

doIt "kvlViewImage aseg_thresholded_resampled.mgz imageDump_coregistered.mgz";

 
