---====--- PLAN

featureset 1

- X/GL window embedded in tcl/tk frame
- multiple volume loading
- window supports multiple viewpane configs
- viewing pane supports 
  - multiple orientations
   - overlays of loaded volumes
   - grayscale or LUT
- output shows values and coordinate systems
- volume editing
- selection
- control points


components:

TCLCommandManager
 - AddListener( RespondToCommandFunc )
 - AddCommand( commandName, arguments.. )
 - SendCommand( commandName, arguments... )
 - keeps list of commands
 - registers single processing function with TCL
 - on called, compare command name with stored list, then lookup listeners to that command and broadcast to them
 - typdef (void)(RespondToCommandFunc)( commandName, arguments... )

DataManager
 - LoadVolume( name );
 - LoadSurface( name );
 - void ReleaseVolume( MRI* );
 - void ReleaseSurface( MRIS* );
 - loads data and keeps track of it
   - if another layer request the data, will just hand them the pointer
   - does reference counting

PreferencesManager
 - UseFile ( fname )
   - look in ./fname, ~/fname etc
 - RegisterPref{Int,Float,String}( keyName, description, defaultValue )
   - if not found, writes entry in prefs file with description in comments and default value
 - {Set,Get}PrefAs{Int,Float,String}( keyName )
   - set or return value from prefs file

DataCollection
 - static DataCollection* GetDataCollection( CollectionID );
 - Unload()
 - holds a central data type and then associated data
 - GetInfoAtRAS( iX,iY,iZ, oasLabels, oasValues )

VolumeDataCollection : DataCollection
 - MRI*
 - selection list
 - transform stuff

SurfaceDataCollection : DataCollection
 - MRIS*
 - selection list
 - scalars

DataCollectionFactory
 - static CollectionID NewDataCollection( iType );

ToglManager
 - all togl stuff
 - passes to a Frame
 - Tcl: Click(iX,iY), MouseMoved(iX,iY)

Frame:
 - 1..n views
 - manages configuration, passing clicks along, key events, to proper view
 - other objects can register for idle events
 - tool modes
 - GetInfoAtWindowLocation( iX,iY, ocPairs, oasLabels, oasValues )

View
 - manages 1..n layers
 - manages clicks, polling data, sending updates to tcl
 - tells layers to draw into proper GL area
 - orientation : 2D: plane, zoom, view center, tp, condition
                 3D: camera location, look, up
 - knows RAS coordinate space , converts window<->RAS
 - GetInfoAtWindowLocation( iX,iY, ocPairs, oasLabels, oasValues )
 - link information: type, which views are linked
 - SetCursor()
 - SetLayers( iczLayers, iaLayerIDs ) 

Layer
 - static Layer& GetLayer( LayerID );
 - static GetLayerIDList( oczLayers, oaLayerIDs )
 - Layer ( collectionID )
 - GetInfoAtRAS( iX,iY,iZ ocPairs, oasLabels, oasValues )
 - drawing attributes:
   - opactiy
   - drawing level : 0 for base, 1 for overlay, or user-settable
   - modes supported : 2D, 3D, graph, etc,
   - transform : transform for this layer
 - subclasses
   - contruction checks if collection type is appropriate for this layer
   - 2DMRI( VolumeDataCollection )
     - draws slices
     - color scale : gray, color, or LUT
     - LUT file
     - sample type : nearest, trilinear, sinc
   - 2DMRIS( SurfaceDataCollection )
     - does intersections
     - scalar files, color scale for each
     - interpolation type
   - 3DMRIS( SurfaceDataCollection )
     - draws mesh
     - scalar files, color scale for each
   - Graph( VolumeDataCollection )
     - current time point, condition

LayerFactory
 - static LayerID NewLayer( iType );


on redraw:
ToglFrame
  - for each view, view->Draw( this->Mode )
View::Draw( iMode )
  - for each drawing level 0..n
    - for each layer in this level
      - layer->DrawIntoView( this->ViewInfo, this->Mode, this->Orientation )
Layer::DrawIntoView
  - 2DMRI
    - find bounds in volume from view bounds
    - for each voxel
      - get value -> color, apply color scale etc
      - apply with opacity to existing buffer (from ViewInfo)
  - 2DMRIS
    - do intersection to find draw list
    - apply color to vertex etc




volume loading
 - Menu command: Load Volume...
 - Tk dlog box for loading volume
     - Volume FN, optional label
     - checkbox for Automatically Create Layer, with optional transform FN

     collectionID NewVolumeDataCollection <volume_fn> <label>
     if bCreateLayer
       set layerID [New2DMRILayer collectionID]
       if bTransform       
         SetLayerTransform layerID <fnTransform>

- layer info manager
 - use [GetLayerIDList] to get list of layers
 - scrolling list of panels, for each layer
   set type [GetLayerType layerID]
   switch type {
     make widgets for layer info and settings
   }

- view info manager
 - for each view, list of possible layers, can add remove and reorder

- info update
 - tk send mouse location to ToglManager
   - send to Frame
     - send to View
       - view transforms to 3/5D point, calls on Layers
         - polls DataCollection for info

- linked cursors
 - tk pass clicks to ToglManager
   - passes to Frame, interprets tool and calls tool function
     - View gets SetCursor()
       - if View is linked, goes through static list of linked Views and calls SetCursor()
